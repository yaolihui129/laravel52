var DATA;
var ops;
var leftMenu;
var treeMenus;
// 面板类
Deskpanel = function(me) {
        return me = {
            init: function() {

            }
        }
    }()
    // 导航类
Navbar = function(me) {
    return me = {
        initOwn: function() {},
        init: function() {
            me.initOwn();
            me.create();
            me.bindEvent();
        },
        create: function() {
            me.changeTab();
            // me.createTopNavbar();// 上导航
            me.createLeftNavbar(); // 左导航
        },
        createTopNavbar: function() {
            $("#leftWrapper")
                .append(
                    "<nav class='navbar navbar-fixed-top' role='navigation'>" +
                    "<div class='navbar-header'>" +
                    "<a class='navbar-brand' href='#'><img src='../../images/icon/2/logo_03.png'></a>" +
                    "<a class='navbar-minimalize minimalize-styl-2 btn btn-primary' href='#'>" +
                    "<i class='fa fa-bars'></i> </a></div><div class='form-group'>" +
                    "<ul id='topUl' class='nav navbar-nav'></ul></div></nav>");

        },
        createLeftNavbar: function() {
            var idx = 1;
            for (var op in DATA.menu) {
                for (var i = 0; i < treeMenus.length; i++) {
                    var pmenu = treeMenus[i];
                    if (pmenu.classfiyId != DATA.menu[op].code)
                        continue;
                    var active = "";
                    if (i == 0)
                        active = "active";
                    var ulId = "side-menu" + i;
                    $("#leftNavbar").append(
                        "<ul class='first-nav' id='" + ulId + "'></ul>");
                    var sonMenus = pmenu.sonMenu;
                    var icon = "";
                    if (sonMenus.length > 0) {
                        icon = "<i class='icon less plus'></i>";
                    }
                    $("#" + ulId).append(
                        "<a href='#' class='" + pmenu.className +
                        " clearfix " + active +
                        "'><b></b><span class='icon'></span>" +
                        pmenu.name + icon + "</a>");
                    drawMenu(sonMenus, ulId, ulId);
                    $("ol[parent='" + ulId + "']").hide();
                }
            }
            $("#leftNavbar").css("min-height", $(".content").height());
            // 递归拼写菜单
            function drawMenu(sonMenus, navId, parentId, level) {
                if (level == undefined)
                    level = 1;
                var sonLen = sonMenus.length;
                if (sonLen) {
                    var navLevelCss = "second-nav";
                    switch (level) {
                        case 2:
                            navLevelCss = "third-nav";
                            break;
                    }
                    var olId = navId + "_" + level;
                    $("#" + navId).append(
                        "<ol class='" + navLevelCss + "' id='" + olId +
                        "' parent='" + parentId + "'></ol>");
                    for (var i = 0; i < sonLen; i++) {
                        parentId = olId + "_" + i;
                        var cMenus = sonMenus[i];
                        var icon = "";
                        var soncMenu = cMenus.sonMenu;
                        if (soncMenu.length > 0) { // 有子节点
                            icon = "<i class='icon less plus'></i>";
                            $("#" + olId)
                                .append(
                                    "<li id='" +
                                    parentId +
                                    "' endNode='false'><b></b><a href='javascript:void(0);'>" +
                                    cMenus.name + icon +
                                    "</a></li>");
                            drawMenu(soncMenu, olId, parentId, (++level));
                        } else {
                            icon = "<i class='icon less'></i>";
                            var href = "";
                            if (cMenus.url != "")
                                href = cMenus.url + "?au=" + cMenus.appid;
                            $("#" + olId)
                                .append(
                                    "<li id='" +
                                    parentId +
                                    "' endNode='true' class='has'><a class='J_menuItem' href='" +
                                    href + "' data-index='" +
                                    idx + "'><b></b>" + icon +
                                    cMenus.name + "</a></li>");
                            idx++;
                        }
                        $("ol[parent='" + parentId + "']").hide();
                    }
                }
            }
        },
        bindEvent: function() {
            $("ul.first-nav>a")
                .click(
                    function() {
                        $(this).siblings('ol,ul').find('li')
                            .removeClass("active");
                        $(this).parents().siblings('ol,ul').find('li')
                            .removeClass("active");
                        $(this).addClass("active").parents("ul")
                            .siblings("ul.first-nav").find("a")
                            .removeClass("active");
                        var conId = $(this).parents("ul").attr("id");
                        rollScreen($(this), conId);
                        return false;
                    })
            $("ol.second-nav li").click(function() {
                menuActiveClick($(this));
                if ($(this).attr("endNode") == "false") {
                    var conId = $(this).attr("id");
                    rollScreen($(this), conId);
                }
                return false;
            })
            $(".J_menuItem").click(function() {
                menuActiveClick($(this));
            });

            function menuActiveClick(obj) {
                obj.parent().parents("ul").find('a').removeClass("active");
                obj.parents("ul.first-nav").siblings().find("a").removeClass(
                    "active");
                obj.parents("ul.first-nav").siblings().find("ol li")
                    .removeClass("active");
                obj.addClass("active").siblings().removeClass("active");
            }

            function rollScreen(obj, conId) {
                if (obj.find("i").hasClass("plus")) {
                    obj.find("i").removeClass("plus");
                    $("[parent='" + conId + "']").show(300);
                } else {
                    obj.find("i").addClass("plus");
                    $("[parent='" + conId + "']").hide(300);
                }
                // $("#leftNavbar").height(1000);
            }
        },
        changeTab: function(thisObj) {}
    }
}()
$(document).ready(
    function() {
        CommonUtil.requestService("/desktop/menus", "", false, "get",
            function(data, status) {
                if (data.success) { // 成功
                    DATA = CommonUtil.parseToJson(data.allmenus.DATA);
                    ops = data.allmenus.ops;
                    leftMenu = data.allmenus.leftMenu;
                    treeMenus = CommonUtil.parseToJson(data.allmenus.treeMenus);
                    Deskpanel.init();
                    Navbar.init();
                } else {

                }
            },
            function(error) {

            }
        );

    }
);